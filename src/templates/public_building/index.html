{% extends "templates/base_index_v2.html" %}
{% block title %}{{ i18n('interface.public_building.title') }}{% endblock %}
{% block new_resource_label %}{{ i18n('interface.public_building.new_public_building') }}{% endblock %}
{% block breadcrumb %}
<nav aria-label="breadcrumb">
    <ol class="breadcrumb">
        <li class="breadcrumb-item active">{{ utils.render_icon('house-door-fill') }}</li>
        <li class="breadcrumb-item active">Quản lý tài sản</li>
        <li class="breadcrumb-item" aria-current="page">Nhà công sản</li>
    </ol>
</nav>
{% endblock %}
{% block scripts %}
{{super()}}
<script src="{{ url_for('static', filename='libs/select2/select2.min.js') }}"></script>
{% endblock %}
{% block styles %}
{{ super() }}
<link href="{{ url_for('static', filename='libs/select2/select2.min.css') }}" rel="stylesheet">
<style>
    #tab-DuLieuModal .nav-link {
        color: #7B809A;
    }

    #tab-DuLieuModal .nav-link.active {
        color: #fff;
        background-color: #0093D8;
    }

    #v-pills-tab {
        min-width: 125px;
        border-right: 1px solid #f5f5f5;
    }

    #v-pills-tabContent .tab-pane.active {
        display: inline-flex;
    }

    #btn-DuLieuTaiSan {
        color: blue;
        text-decoration: underline;
    }

    .select2-container {
        width: 100% !important;
    }

    @media (min-width: 576px) {
        #createTab1Modal .modal-dialog {
            max-width: 1500px !important;
        }
    }
</style>
{% endblock %}
{% block table %}
<ul class="nav nav-tabs w-100" id="tabNhaCongSan" role="tablist">
    <li class="nav-item" role="presentation">
        <button class="nav-link active" id="tabDuLieuChinh" data-bs-toggle="tab" data-bs-target="#tab-DuLieuChinh"
            data-target-modal="#createTab1Modal" type="button" role="tab" aria-controls="tab-DuLieuChinh"
            aria-selected="true">Ds nhà công sản</button>
    </li>
    <!-- <li class="nav-item" role="presentation">
        <button class="nav-link" id="tabChoPheDuyet" data-bs-toggle="tab" data-bs-target="#tab-ChoPheDuyet"
            data-target-modal="#createTab2Modal" type="button" role="tab" aria-controls="tab-ChoPheDuyet"
            aria-selected="false">Ds chờ phê duyệt</button>
    </li> -->
</ul>
<div class="tab-content px-4 py-4">
    <div class="tab-pane fade show active" id="tab-DuLieuChinh" role="tabpanel" aria-labelledby="tab-DuLieuChinh">
        <table id="tableDuLieuChinh" class="display responsive">
            <thead>
                <tr>
                    <th>STT</th>
                    <th style="min-width: 200px;">Mã tài sản</th>
                    <th style="min-width: 200px;">Tên tài sản</th>
                    <th style="min-width: 200px;">Địa chỉ</th>
                    <th style="min-width: 142px;">Số tờ</th>
                    <th style="min-width: 142px;">Số thửa</th>
                    <th style="min-width: 200px;">Ảnh/Văn bản</th>
                    <th style="min-width: 100px;">Ngày tạo</th>
                    <th class="text-center" style="min-width: 100px;">Tác vụ</th>
                </tr>
            </thead>
            <tbody>
            </tbody>
        </table>
    </div>
    <div class="tab-pane fade" id="tab-ChoPheDuyet" role="tabpanel" aria-labelledby="tab-ChoPheDuyet">
        <!-- <table id="tableChoPheDuyet" class="display responsive">
            <thead>
                <tr>
                    <th>STT</th>
                    <th style="min-width: 175px;">Tên nhóm tham số</th>
                    <th style="min-width: 100px;">Thứ tự hiển thị</th>
                    <th style="min-width: 100px;">Ngày tạo</th>
                    <th class="text-center" style="min-width: 100px;">Tác vụ</th>
                </tr>
            </thead>
            <tbody>
            </tbody>
        </table> -->
    </div>
</div>
{% endblock %}
{% block addNewModal %}
<div class="modal fade" id="chonTaiSanCoSanModal" tabindex="-1" data-bs-keyboard="false" data-bs-backdrop="static"
    aria-labelledby="chonTaiSanCoSanModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    Chọn mã tài sản có sẵn
                </h5>
            </div>
            <div class="modal-body my-2">
                <div class="d-flex justify-content-center">
                    <form id="dmPhanLoaiTSForm" class="row g-3 needs-validation" novalidate method="post">
                        <div class="d-flex w-100 flex-column">
                            <p class="text-center">Vui lòng lựa chọn mã tài sản có sẵn trong hệ thống.</p>
                            <select id="select-maTaiSan" class="form-control w-100" name="selectMaTaiSan"></select>
                        </div>
                    </form>
                </div>
                <div class="d-flex m-4" id="select-content-detail"></div>
                <div class="d-flex justify-content-center mt-4" style="gap: 10px;">
                    <button type="button" class="btn btn-maTaiSan-next">{{ utils.render_icon('arrow-right') }} Tiếp
                        tục</button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{{
                        utils.render_icon('x-circle') }}
                        Hủy</button>
                </div>
            </div>
        </div>
    </div>
</div>
<div class="modal fade" id="chonLyDoCapNhatDuLieuModal" tabindex="-1" data-bs-keyboard="false" data-bs-backdrop="static"
    aria-labelledby="chonLyDoCapNhatDuLieuModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    Cập nhật dữ liệu
                </h5>
            </div>
            <div class="modal-body my-2">
                <div class="d-flex justify-content-center">
                    <form id="lyDoCapNhatDuLieuForm" class="row g-3 needs-validation" novalidate method="post">
                        <div class="d-flex w-100 flex-column">
                            <p class="text-center">Vui lòng lựa chọn lý do cập nhật dữ liệu.</p>
                            <select id="select-lyDoCapNhatDuLieu" class="form-control w-100"
                                name="selectLyDoCapNhatDuLieu"></select>
                        </div>
                    </form>
                </div>
                <div class="d-flex m-4" id="select-content-detail"></div>
                <div class="d-flex justify-content-center mt-4" style="gap: 10px;">
                    <button type="button" class="btn btn-theme btn-lyDoCapNhatDuLieu-next"
                        onclick="showUpdateTab1Modal()">{{ utils.render_icon('arrow-right') }}
                        Tiếp
                        tục</button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{{
                        utils.render_icon('x-circle') }}
                        Hủy</button>
                </div>
            </div>
        </div>
    </div>
</div>
<div class="modal fade" id="fileDinhKemModal" tabindex="-1" data-bs-keyboard="false" data-bs-backdrop="static"
    aria-labelledby="fileDinhKemModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    Danh sách file ảnh / văn bản
                </h5>
                <div>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{{
                        utils.render_icon('x-circle') }}
                        Thoát</button>
                </div>
            </div>
            <div class="modal-body my-2">
                <ul id="lstFileDinhKiemModal"></ul>
            </div>
        </div>
    </div>
</div>
<div class="modal fade" id="historyEditModal" tabindex="-1" data-bs-keyboard="false" data-bs-backdrop="static"
    aria-labelledby="historyEditModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    Lịch sử chỉnh sửa
                </h5>
                <div>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{{
                        utils.render_icon('x-circle') }}
                        Thoát</button>
                </div>
            </div>
            <div class="modal-body my-2">
                <div class="content-history"></div>
            </div>
        </div>
    </div>
</div>
{% endblock %}
{% block titleStep1Modal %}
Thêm mới dữ liệu nhà công sản
{% endblock %}
{% block bodyStep1Modal %}
<form id="dmPhanLoaiTSForm" class="row g-3 needs-validation" novalidate method="post">
    <div class="d-flex w-100 flex-column">
        <p class="text-center">Vui lòng lựa chọn danh mục phân loại tài sản cho nhà công sản.</p>
        <select id="select-phan-loai-ts" class="form-control w-100" name="ten_loai_ts"></select>
    </div>
</form>
{% endblock %}
{% block bodyCreateTab1Modal %}
<ul class="nav nav-tabs w-100" id="tabDuLieuChinhModal" role="tablist">
    <li class="nav-item" role="presentation">
        <button class="nav-link active" id="tabDuLieuModal" data-bs-toggle="tab" data-bs-target="#tab-DuLieuModal"
            type="button" role="tab" aria-controls="tab-DuLieuModal" aria-selected="true">Dữ liệu</button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="tabBanDoModal" data-bs-toggle="tab" data-bs-target="#tab-BanDoModal" type="button"
            role="tab" aria-controls="tab-BanDoModal" aria-selected="false">Bản đồ</button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="tabHistoryModal" data-bs-toggle="tab" data-bs-target="#tab-HistoryModal"
            type="button" role="tab" aria-controls="tab-HistoryModal" aria-selected="false">Lịch sử thay đổi</button>
    </li>
</ul>
<div class="tab-content py-4">
    <div class="tab-pane fade show active" id="tab-DuLieuModal" role="tabpanel" aria-labelledby="tab-DuLieuModal">
        <form id="duLieuChinhForm" class="row g-3 needs-validation" novalidate method="post">
            <input type="text" name="id" hidden />
            <input type="text" name="lyDoChinhSuaID" hidden />
            <input type="text" name="lyDoChinhSuaTEXT" hidden />
            <div class="d-flex align-items-start">
                <div class="nav flex-column nav-pills me-3 pe-2" id="v-pills-tab" role="tablist"
                    aria-orientation="vertical">
                </div>
                <div class="tab-content tab-validate row w-100" id="v-pills-tabContent">
                </div>
            </div>
        </form>
    </div>
    <div class="tab-pane fade" id="tab-BanDoModal" role="tabpanel" aria-labelledby="tab-BanDoModal">
        <iframe id="iframe-map"
            src="/map_viewer/?t=DaNang_PBM_Shpfile_v2&l=edit_polygons%2CDaNang_PBM_Shpfile%20—%20DAT_CS_METADATA%2CDaNang_PBM_Shpfile%20—%20NHA_CS_METADATA%2COpenStreetMap&bl=&c=12042746%2C1810986&s=20000"
            width="100%" height="600px" frameborder="0" allowfullscreen
            sandbox="allow-scripts allow-same-origin allow-top-navigation allow-forms allow-popups allow-pointer-lock allow-popups-to-escape-sandbox"></iframe>
    </div>
    <div class="tab-pane fade" id="tab-HistoryModal" role="tabpanel" aria-labelledby="tab-HistoryModal">
        <p class="text-center">Không có dữ liệu.</p>
    </div>
</div>
{% endblock %}

{% block renderScripts %}
<script type="text/javascript">
    document.addEventListener('DOMContentLoaded', function () {
        // Init show modal create
        const createButton = document.getElementById('createModal');
        if (createButton) {
            createButton.setAttribute('data-bs-target', '#step1Modal')
        }

        $("#select-phan-loai-ts").select2({
            placeholder: 'Chọn danh mục phân loại tài sản...',
            allowClear: true,
            minimumInputLength: 0, // Number of characters before AJAX request is made
            dropdownParent: $('#step1Modal'),
            ajax: {
                url: 'api/asset-type/type/categories/all', // API endpoint URL
                dataType: 'json',
                delay: 250,
                processResults: function (data) {
                    return {
                        results: data.result
                    };
                },
                cache: true
            }
        });

        // Load danh mục lý do cập nhật dữ liệu
        $("#select-lyDoCapNhatDuLieu").select2({
            placeholder: 'Chọn lý do cập nhật dữ liệu...',
            // allowClear: true,
            minimumInputLength: 0, // Number of characters before AJAX request is made
            dropdownParent: $('#chonLyDoCapNhatDuLieuModal'),
            ajax: {
                url: 'api/categories/LyDoCapNhatDL/all', // ma_nhom: HTSD | Hiện trạng sử dụng
                dataType: 'json',
                delay: 250,
                processResults: function (data) {
                    return {
                        results: data.result
                    };
                },
                cache: true
            }
        });

        // TODO
        let listMaTaiSan = [];
        $("#select-maTaiSan").select2({
            placeholder: 'Chọn mã tài sản...',
            allowClear: true,
            minimumInputLength: 0, // Number of characters before AJAX request is made
            dropdownParent: $('#chonTaiSanCoSanModal'),
            ajax: {
                url: 'api/public-building/categories/all', // API endpoint URL
                dataType: 'json',
                delay: 250,
                processResults: function (data) {
                    listMaTaiSan = data;
                    return {
                        results: data.result
                    };
                },
                cache: true
            }
        });

        // Event listener for change event
        $("#select-maTaiSan").on('change', function () {
            var selectedValue = $(this).val();
            // Add any additional logic you want to execute on change
            let itemSelected = listMaTaiSan['result'].filter(x => x.id === selectedValue);
            const selectMaTaiSan = document.getElementById("select-content-detail");
            if (selectedValue) {
                selectMaTaiSan.innerHTML = `
                    <ul>
                        <li>Mã tài sản: ${itemSelected[0].id}</li>
                        <li>Tên tài sản: ${itemSelected[0].ten_tai_san}</li>
                        <li>Địa chỉ: ${itemSelected[0].dia_chi}</li>
                        <li>Mã số tờ: ${itemSelected[0].ma_to_thua}</li>
                        <li>Mã số thửa: ${itemSelected[0].ma_to_dat}</li>
                    </ul>
                `;
            } else {
                selectMaTaiSan.innerHTML = '';
            }
        });

        $('#chonTaiSanCoSanModal').on('shown.bs.modal', function () {
        });

        $('#chonTaiSanCoSanModal').on('hide.bs.modal', function () {
            $('#createTab1Modal').modal('show');
        });

        $('#createTab1Modal').on('shown.bs.modal', function () {
            let id = $('#createTab1Modal input[name="id"]').val();

            //
            const iframe = document.getElementById('iframe-map');
            const currentUrl = new URL(iframe.src);

            if (!id) {
                $('#createTab1Modal .modal-title').html('Thêm mới dữ liệu');
                // Nếu là thêm mới thì tự động gợi ý mã tài sản
                const timestamp = Math.floor(Date.now() / 1000);
                let valMaTaiSan = `NDCS-${new Date().getFullYear()}${timestamp}`;
                $('#createTab1Modal input[name="ma_tai_san"]').val(valMaTaiSan);
                $('.btn-save').show();
            } else {
                getDetailHistoryById(id);
            }

            // UPdate url iframe bản đồ
            currentUrl.searchParams.set('st', $('#createTab1Modal input[name="ma_tai_san"]').val());
            // Cập nhật src của iframe
            iframe.src = currentUrl.toString();

            renderSelectAddress();
            renderFormatDate();
            initEventChangeUploadFile();

        });

        $('#createTab1Modal').on('hide.bs.modal', function () {
            $('#duLieuChinhForm')[0].reset();
            $('#tab-HistoryModal').html('');
            $('.btn-save').hide();
        })


        // MODAL Lý do cập nhật dữ liệu
        $('#chonLyDoCapNhatDuLieuModal').on('shown.bs.modal', function () {
            // TODO
        })

        $('#chonLyDoCapNhatDuLieuModal').on('hide.bs.modal', function () {
            $('#lyDoCapNhatDuLieuForm')[0].reset();
            $('#select-lyDoCapNhatDuLieu').val(null).trigger('change');
        })

    })

    let globalParams = [];
    $(document).ready(function () {
        // Search data
        $('.btn-search').on('click', function () {
            tableDuLieuChinh.ajax.reload(null, false);
        })

        $('#input-search').on('keydown', function (e) {
            if (event.key === "Enter" || event.keyCode === 13) {
                tableDuLieuChinh.ajax.reload(null, false);
            }
        })

        // Validate lựa chọn danh mục phân loại tài sản
        $('#dmPhanLoaiTSForm').validate({
            rules: {
                ten_loai_ts: {
                    required: true
                }
            },
            messages: {
                ten_loai_ts: {
                    required: "Vui lòng nhập chọn danh mục.",
                }
            },
            errorClass: "is-invalid",
            validClass: "is-valid",
            errorElement: "div",
            errorPlacement: function (error, element) {
                if (element.hasClass('select2-hidden-accessible')) {
                    // Insert the error message after the Select2 container
                    error.addClass("invalid-feedback");
                    error.insertAfter(element.next('.select2-container'));
                } else {
                    error.addClass("invalid-feedback");
                    error.insertAfter(element);
                }
            },
            highlight: function (element, errorClass, validClass) {
                $(element).addClass(errorClass).removeClass(validClass);
                if ($(element).hasClass('select2-hidden-accessible')) {
                    $(element).next('.select2-container').addClass(errorClass);
                }
            },
            unhighlight: function (element, errorClass, validClass) {
                $(element).removeClass(errorClass).addClass(validClass);
                if ($(element).hasClass('select2-hidden-accessible')) {
                    $(element).next('.select2-container').removeClass(errorClass);
                }
            }
        });

        $('#step1Modal .btn-step1-next').on('click', async function () {
            if ($('#dmPhanLoaiTSForm').valid()) {
                const id = $('#select-phan-loai-ts').val();
                // Get all param
                await renderTabAndContentUI(id);

            } else {
                toastr.error('Vui lòng nhập đầy đủ trường bắt buộc.');
            }
        });

        const fieldDuLieuChinh = [
            "stt",
            "ma_tai_san",
            "ten_tai_san",
            "full_dia_chi",
            "so_to",
            "so_thua",
            "ds_file_dinh_kem_info",
            "ngay_tao",
            "tac_vu"
        ];

        let tableDuLieuChinh = new DataTable('#tableDuLieuChinh', {
            dom: 'rtlip',
            ordering: true,
            scrollY: 300,
            scrollX: true,
            scrollCollapse: true,
            processing: true,
            serverSide: true,
            searching: { regex: true },
            pageLength: 10,
            responsive: false,
            pagingType: "simple_numbers",
            language: PBMSLang,
            order: [],
            ajax: {
                url: "api/public-building/page",
                type: "POST",
                contentType: 'application/json',
                dataType: "json",
                headers: {
                    'X-CSRF-Token': $('input[name="csrf_token"]').val() // Include the CSRF token in the headers
                },
                data: function (d) {
                    d.search.value = $('input[name=txt-search]').val();
                    return JSON.stringify(d);
                },
                dataSrc: function (json) {
                    json.recordsTotal = json.result.recordsTotal;
                    json.recordsFiltered = json.result.recordsFiltered;
                    return json.result.data;
                }
            },
            initComplete: function () {

            },
            columnDefs: [
                { "defaultContent": "", "targets": "_all" },
                {
                    orderable: false, targets: getIdxFieldTable(fieldDuLieuChinh,
                        ['stt', 'ds_file_dinh_kem_info', 'ngay_tao', 'tac_vu'])
                },
                {
                    data: '',
                    targets: getIdxFieldTable(fieldDuLieuChinh, ['stt']),
                    render: function (data, type, full, meta) {
                        return meta.settings._iDisplayStart + meta.row + 1;
                    },
                },
                {
                    data: 'ds_file_dinh_kem_info',
                    targets: getIdxFieldTable(fieldDuLieuChinh, ['ds_file_dinh_kem_info']),
                    render: function (data, type, full, meta) {
                        const files = data && data !== '' ? JSON.parse(data) : null;
                        return `<a class="btn btn-default btn-upload" onclick='clickShowFiles(${JSON.stringify(data)})'>
                                        {{ utils.render_icon('link-45deg') }} File đính kèm (${files?.length || 0})
                                    </a>`;
                    }
                },
                {
                    data: '',
                    targets: getIdxFieldTable(fieldDuLieuChinh, ['tac_vu']),
                    render: function (data, type, full, meta) {
                        return `<div class="btn-action text-center">
                                    <a class="btn btn-icon-view" role="button" title="Xem chi tiết" onclick="showDetailTab1Modal('${full.id}')">
                                        <span class="svg-icon svg-icon-view"></span>    
                                    </a>
                                    <a class="btn btn-icon-edit" role="button" title="Sửa" onclick="showLyDoCapNhatDuLieuModal('${full.id}')">
                                        <span class="svg-icon svg-icon-edit"></span>    
                                    </a>    
                                    <a class="btn btn-icon-delete" role="button" onclick="showDeleteTab1Modal('${full.id}')">
                                        <span class="svg-icon svg-icon-delete" title="Xóa"></span>
                                    </a>    
                                </div>`
                    },
                },
            ],
            columns: [
                { className: 'noVis', targets: [0] },
                { data: 'ma_tai_san' },
                { data: 'ten_tai_san' },
                { data: 'full_dia_chi' },
                { data: 'so_to' },
                { data: 'so_thua' },
                { data: 'ds_file_dinh_kem_info' },
                { data: 'ngay_tao' },
                { className: 'noVis' },
            ]
        });

        $('#duLieuChinhForm').validate({
            rules: {
                ma_tai_san: {
                    required: true,
                },
                ten_tai_san: {
                    required: true,
                },
                so_to: {
                    required: true,
                },
                so_thua: {
                    required: true,
                },
                dia_chi: {
                    required: true,
                    maxlength: 500
                },
                ma_px: {
                    required: true,
                },
                ma_qh: {
                    required: true,
                },
                ma_tp: {
                    required: true,
                }
            },
            messages: {
                ma_tai_san: {
                    required: "Vui lòng nhập mã tài sản.",
                },
                ten_tai_san: {
                    required: "Vui lòng nhập tên tài sản.",
                },
                so_to: {
                    required: "Vui lòng nhập số tờ.",
                },
                so_thua: {
                    required: "Vui lòng nhập số thửa.",
                },
                dia_chi: {
                    required: "Vui lòng nhập địa chỉ.",
                    maxlength: "Tên nhóm tham số có độ dài tối đa 500 kí tự."
                },
                ma_px: {
                    required: "Vui lòng chọn Phường/Xã.",
                },
                ma_qh: {
                    required: "Vui lòng chọn Quận/Huyện.",
                },
                ma_tp: {
                    required: "Vui lòng chọn Tỉnh/TP.",
                },
            },
            errorClass: "is-invalid",
            validClass: "is-valid",
            errorElement: "div",
            errorPlacement: function (error, element) {
                if (element.hasClass('select2-hidden-accessible')) {
                    // Insert the error message after the Select2 container
                    error.addClass("invalid-feedback");
                    error.insertAfter(element.next('.select2-container'));
                } else {
                    error.addClass("invalid-feedback");
                    error.insertAfter(element);
                }
            },
            highlight: function (element, errorClass, validClass) {
                $(element).addClass(errorClass).removeClass(validClass);
                if ($(element).hasClass('select2-hidden-accessible')) {
                    $(element).next('.select2-container').addClass(errorClass);
                }
            },
            unhighlight: function (element, errorClass, validClass) {
                $(element).removeClass(errorClass).addClass(validClass);
                if ($(element).hasClass('select2-hidden-accessible')) {
                    $(element).next('.select2-container').removeClass(errorClass);
                }
            }
        });

        // Tạo mới loại tài sản
        $('#createTab1Modal .btn-save').on('click', function () {
            if ($('#duLieuChinhForm').valid()) {
                // Collect form data
                const formData = new FormData($('#duLieuChinhForm')[0]);
                // Gán lại giá trị
                formData.append('ma_tai_san', $('input[name="ma_tai_san"]').val());
                formData.append('phan_loai_tai_san_id', $('select[name="phan_loai_tai_san_id"]').val());
                // Truyền lại danh sách param
                formData.append('body_params', JSON.stringify(globalParams));
                if ($("#select-province").val())
                    formData.append('ten_tp', $("#select-province").select2('data')[0].text);
                if ($("#select-district").val())
                    formData.append('ten_qh', $("#select-district").select2('data')[0].text);
                if ($("#select-ward").val())
                    formData.append('ten_px', $("#select-ward").select2('data')[0].text);

                // Check upload file
                // const fileUploads = document.querySelectorAll('input[type="file"]');
                // fileUploads.forEach(item => {
                //     const files = item.files;
                //     for (var i = 0; i < files.length; i++) {
                //         console.log(item.name);
                //         console.log(files[i]);
                //         formData.append(`${item.name}`, files[i]);
                //     }
                // })

                // Make AJAX call
                let ajax_url = 'api/public-building/create';
                let ajax_type = 'POST';
                let paramId = $('#duLieuChinhForm input[name="id"]').val();
                // Tồn tại Id thì call api update
                if (paramId) {
                    ajax_url = `api/public-building/update/${paramId}`;
                    ajax_type = 'PUT';
                }

                $.ajax({
                    url: ajax_url, // Replace with your API endpoint
                    type: ajax_type,
                    headers: {
                        'X-CSRF-Token': $('input[name="csrf_token"]').val() // Include the CSRF token in the headers
                    },
                    contentType: false, // Set content type to false for FormData
                    processData: false, // Prevent jQuery from setting the Content-Type header
                    data: formData, // Use FormData directly
                    success: function (res) {
                        // Handle success
                        toastr.success(res.message);
                        // Optionally, close the modal or reset the form
                        $('#createTab1Modal').modal('hide');
                        // Reload datatable
                        tableDuLieuChinh.ajax.reload(null, false);
                    },
                    error: function (err) {
                        // Handle error
                        toastr.error(err.error);
                    }
                });
            }
        });

        window.showLyDoCapNhatDuLieuModal = function (id) {
            $('#chonLyDoCapNhatDuLieuModal').modal('show');
            $('#select-lyDoCapNhatDuLieu').attr('data-row-id', id);
        }

        window.showDetailTab1Modal = function (id) {
            getDetailNhaById(id, 'VIEW');
        }

        window.showUpdateTab1Modal = function () {
            // Khởi tạo validate form
            $('#lyDoCapNhatDuLieuForm').validate({
                rules: {
                    selectLyDoCapNhatDuLieu: {
                        required: true,
                    }
                },
                messages: {
                    selectLyDoCapNhatDuLieu: {
                        required: "Vui lòng chọn lý do.",
                    }
                },
                errorClass: "is-invalid",
                validClass: "is-valid",
                errorElement: "div",
                errorPlacement: function (error, element) {
                    if (element.hasClass('select2-hidden-accessible')) {
                        // Insert the error message after the Select2 container
                        error.addClass("invalid-feedback");
                        error.insertAfter(element.next('.select2-container'));
                    } else {
                        error.addClass("invalid-feedback");
                        error.insertAfter(element);
                    }
                },
                highlight: function (element, errorClass, validClass) {
                    $(element).addClass(errorClass).removeClass(validClass);
                    if ($(element).hasClass('select2-hidden-accessible')) {
                        $(element).next('.select2-container').addClass(errorClass);
                    }
                },
                unhighlight: function (element, errorClass, validClass) {
                    $(element).removeClass(errorClass).addClass(validClass);
                    if ($(element).hasClass('select2-hidden-accessible')) {
                        $(element).next('.select2-container').removeClass(errorClass);
                    }
                }
            });

            if ($('#lyDoCapNhatDuLieuForm').valid()) {
                let valLyDoCapNhatDL = $("#select-lyDoCapNhatDuLieu").select2('data')[0].id;
                let textLyDoCapNhatDL = $("#select-lyDoCapNhatDuLieu").select2('data')[0].text;
                $('#duLieuChinhForm [name="lyDoChinhSuaID"]').val(valLyDoCapNhatDL);
                $('#duLieuChinhForm [name="lyDoChinhSuaTEXT"]').val(textLyDoCapNhatDL);
                // Ẩn modal Chọn lý do cập nhật dữ liệu
                $('#chonLyDoCapNhatDuLieuModal').modal('hide');
                const rowID = $('#select-lyDoCapNhatDuLieu').attr('data-row-id');
                // Show modal detail cập nhật dữ liệu
                // Show modal detail cập nhật dữ liệu
                getDetailNhaById(rowID, 'EDIT');
            }
        }

        window.showDeleteTab1Modal = function (id) {
            // Show confirmation modal
            $('#deleteTab1Modal').modal('show');
            // Set the delete button action
            $('#deleteTab1Modal .btn-delete').off('click').on('click', function () {
                // Make AJAX call to delete the item
                $.ajax({
                    url: `api/public-building/delete/${id}`, // Replace with your API endpoint
                    type: 'DELETE',
                    headers: {
                        'X-CSRF-Token': $('input[name="csrf_token"]').val() // Include the CSRF token in the headers
                    },
                    success: function (res) {
                        // Handle success
                        toastr.success(res.message);
                        // Close the modal
                        $('#deleteTab1Modal').modal('hide');
                        // Reload datatable
                        tableDuLieuChinh.ajax.reload(null, false);
                    },
                    error: function (err) {
                        // Handle error
                        toastr.error(err.responseJSON?.error);
                        // Close the modal
                        $('#deleteTab1Modal').modal('hide');
                    }
                });
            });
        }
    })

    function getDetailNhaById(id, action = 'EDIT') {
        $.ajax({
            url: `api/public-building/detail/${id}`, // Replace with your API endpoint
            type: 'GET',
            headers: {
                'X-CSRF-Token': $('input[name="csrf_token"]').val() // Include the CSRF token in the headers
            },
            success: async function (res) {
                const data = res.result;
                $('#duLieuChinhForm [name="id"]').val(data.id);
                // Trigger validation on each field to show feedback
                // Get all param
                await renderTabAndContentUI(data.phan_loai_tai_san_id).then(() => {
                    globalParams.forEach(item => {
                        if (item.kieu_du_lieu === "file") {
                            $(`#duLieuChinhForm [name="${item.ma_truong}_info"]`).val(data[`${item.ma_truong}_info`]);
                            renderPreviewFileUploadOld(item.ma_truong, data[`${item.ma_truong}_info`], action);
                        } else {
                            $(`#duLieuChinhForm [name="${item.ma_truong}"]`).val(data[`${item.ma_truong}`]);
                        }
                    });

                    $('#select-province').append(new Option(data.ten_tp, data.ma_tp, true, true)).trigger('change');
                    $('#select-district').append(new Option(data.ten_qh, data.ma_qh, true, true)).trigger('change');
                    $('#select-ward').append(new Option(data.ten_px, data.ma_px, true, true)).trigger('change');
                    $('#duLieuChinhForm').validate().form();
                    // Show confirmation modal
                    $('#createTab1Modal').modal('show');
                    if (action === 'VIEW') {
                        $('#createTab1Modal .modal-title').html('Xem chi tiết dữ liệu');
                        $('.btn-save').hide();
                    } else {
                        $('#createTab1Modal .modal-title').html('Cập nhật dữ liệu');
                        $('.btn-save').show()
                    }
                });
            },
            error: function (err) {
                // Handle error
                toastr.error(err.responseJSON?.error);
            }
        });
    }

    function generateRandomString(length = 8) {
        const characters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz';
        let result = '';
        for (let i = 0; i < length; i++) {
            result += characters.charAt(Math.floor(Math.random() * characters.length));
        }
        return result;
    }

    function renderUIControl(obj, idTS, tenLoaiTS) {
        let content = '<div class="col-md-6 mt-3">';
        if (obj.ma_truong === 'ma_tai_san') {
            content += `
                    <label for="${obj.ma_truong}" class="form-label">${obj.ten_truong}:</label>
                    <input type="text" class="form-control" name="${obj.ma_truong}" required disabled>
                `;
            // <span class="w-100 mt-1 m-0">
            //     <a id="btn-DuLieuTaiSan" data-bs-toggle="modal" data-bs-target="#chonTaiSanCoSanModal"
            //         role="button">+ Chọn dữ
            //         liệu tài sản có sẵn</a>
            // </span>
        } else if (obj.ma_truong === 'phan_loai_tai_san_id') {
            content += `
                    <label for="${obj.ma_truong}" class="form-label">${obj.ten_truong}:</label>
                    <select class="form-control" name="${obj.ma_truong}" disabled>
                        <option value="${idTS}">${tenLoaiTS}</option>
                    </select>
                `;
        } else if (obj.ma_truong === 'ma_tp') {
            content += `
                    <label for="${obj.ma_truong}" class="form-label">${obj.ten_truong}:</label>
                    <select id="select-province" class="form-control w-100" name="ma_tp"></select>
                `;
        } else if (obj.ma_truong === 'ma_qh') {
            content += `
                    <label for="${obj.ma_truong}" class="form-label">${obj.ten_truong}:</label>
                    <select id="select-district" class="form-control w-100" name="ma_qh"></select>
                `;
        } else if (obj.ma_truong === 'ma_px') {
            content += `
                    <label for="${obj.ma_truong}" class="form-label">${obj.ten_truong}:</label>
                    <select id="select-ward" class="form-control w-100" name="ma_px"></select>
                `;
        } else {
            if (obj.kieu_du_lieu === 'string') {
                content += `
                    <label for="${obj.ma_truong}" class="form-label">${obj.ten_truong}:</label>
                    <input type="text" class="form-control" name="${obj.ma_truong}">
                `;
            } else if (obj.kieu_du_lieu === 'textarea') {
                content += `
                    <label for="${obj.ma_truong}" class="form-label">${obj.ten_truong}:</label>
                    <textarea type="text" class="form-control" rows="3" name="${obj.ma_truong}"></textarea>
                `;
            } else if (obj.kieu_du_lieu === 'integer') {
                content += `
                    <label for="${obj.ma_truong}" class="form-label">${obj.ten_truong}:</label>
                    <input type="number" class="form-control" name="${obj.ma_truong}">
                `;
            } else if (obj.kieu_du_lieu === 'float') {
                content += `
                    <label for="${obj.ma_truong}" class="form-label">${obj.ten_truong}:</label>
                    <input type="number" class="form-control" name="${obj.ma_truong}">
                `;
            } else if (obj.kieu_du_lieu === 'date') {
                content += `
                    <label for="${obj.ma_truong}" class="form-label">${obj.ten_truong}:</label>
                    <input id="${obj.ma_truong}" data-type="date" type="text" placeholder="dd/MM/yyyy" class="form-control" name="${obj.ma_truong}">
                `;
            } else if (obj.kieu_du_lieu === 'file') {
                content += `
                    <label for="${obj.ma_truong}" class="form-label w-100">${obj.ten_truong}:</label>
                    <a class="btn btn-default btn-upload w-50"
                    onclick="document.querySelector('input[name=&quot;${obj.ma_truong}&quot;]').click();">
                        {{ utils.render_icon('upload') }} Tải lên
                    </a>
                    <input type="text" name="${obj.ma_truong}_info" hidden />
                    <input type="file" class="form-control" name="${obj.ma_truong}" multiple accept=".xlsx,.xls,.png,.jpeg,.jpg,.doc,.docx,.pdf" hidden>
                    <ul id="${obj.ma_truong}_new"></ul>
                    <ul id="${obj.ma_truong}_old"></ul>
                `;
            }
        }
        content += '</div>';
        return content;
    }

    function renderSelectAddress() {
        $("#select-province").select2({
            placeholder: 'Chọn Tỉnh/TP...',
            allowClear: true,
            minimumInputLength: 0, // Number of characters before AJAX request is made
            dropdownParent: $('#createTab1Modal'),
            ajax: {
                url: 'api/categories/province', // API endpoint URL
                dataType: 'json',
                delay: 250,
                processResults: function (data) {
                    return {
                        results: data.result
                    };
                },
                cache: true
            }
        });

        $('#select-province').on('select2:select', function (e) {
            // Do something
            let ma_tp = e.target.value;
            $("#select-district").select2({
                placeholder: 'Chọn Quận Huyện...',
                allowClear: true,
                minimumInputLength: 0, // Number of characters before AJAX request is made
                dropdownParent: $('#createTab1Modal'),
                ajax: {
                    url: `api/categories/${ma_tp}/district`, // API endpoint URL
                    dataType: 'json',
                    delay: 250,
                    processResults: function (data) {
                        return {
                            results: data.result
                        };
                    },
                    cache: true
                }
            });
        });
        $('#select-district').on('select2:select', function (e) {
            // Do something
            let ma_qh = e.target.value;
            $("#select-ward").select2({
                placeholder: 'Chọn Phường Xã...',
                allowClear: true,
                minimumInputLength: 0, // Number of characters before AJAX request is made
                dropdownParent: $('#createTab1Modal'),
                ajax: {
                    url: `api/categories/48/${ma_qh}/ward`, // API endpoint URL
                    dataType: 'json',
                    delay: 250,
                    processResults: function (data) {
                        return {
                            results: data.result
                        };
                    },
                    cache: true
                }
            });
        });
        $("#select-district").select2();
        $("#select-ward").select2();
    }

    function renderFormatDate() {
        $('input[data-type="date"]').each(function () {
            $(this).datepicker({
                changeMonth: true,
                changeYear: true
            });
            $(this).datepicker("option", "dateFormat", 'dd/mm/yy');
        });
    }

    async function renderTabAndContentUI(id) {
        await $.ajax({
            url: `/api/asset-type/type/${id}/param`, // Replace with your API endpoint
            type: 'GET',
            headers: {
                'X-CSRF-Token': $('input[name="csrf_token"]').val() // Include the CSRF token in the headers
            },
            success: function (res) {
                // Render UI
                if (res.result) {
                    // Gán lại cho biển global
                    globalParams = res.result.params;

                    const params = res.result.params.reduce((acc, current) => {
                        const x = acc.find(item => item.ten_nhom_tham_so === current.ten_nhom_tham_so);
                        if (!x) {
                            return acc.concat([{ ten_nhom_tham_so: current.ten_nhom_tham_so, items: [current] }]);
                        } else {
                            x.items.push(current);
                            return acc;
                        }
                    }, []);

                    let subjectTAB = '';
                    let contentTAB = '';
                    params.forEach((element, index) => {
                        let guid = generateRandomString();
                        let active = index === 0 ? 'show active' : '';
                        // RENDER TAB
                        subjectTAB += `<button class="nav-link text-start ${active}" id="${guid}-tab" data-bs-toggle="pill"
                        data-bs-target="#${guid}" type="button" role="tab" aria-controls="${guid}"
                        aria-selected="${index === 0}">${element.ten_nhom_tham_so}</button>`;
                        // RENDER CONTENT
                        contentTAB += `<div class="tab-pane row fade ${active}" id="${guid}" role="tabpanel"
                        aria-labelledby="${guid}-tab">`;
                        element.items.forEach((par, index) => {
                            contentTAB += renderUIControl(par, res.result.id, res.result.ten_loai_ts);
                        });
                        contentTAB += `</div>`
                    });

                    $('#v-pills-tab')[0].innerHTML = subjectTAB;
                    $('#v-pills-tabContent')[0].innerHTML = contentTAB;
                }

                $('#step1Modal').modal('hide');
                $('#createTab1Modal').modal('show');
            },
            error: function (err) {
                // Handle error
                toastr.error(err.responseJSON?.error);
            }
        });
    }

    function initEventChangeUploadFile() {
        const inputFiles = document.querySelectorAll(`input[type="file"]`);
        inputFiles.forEach(input => {
            // Khi dữ liệu file thay đổi hiển thị lại preview
            $(`#createTab1Modal input[name="${input.name}"]`).on('change', function (e) {
                const files = e.target.files;
                if (files.length > 0) {
                    // Check kích thước lớn hơn 5MB (5242880 Bytes)
                    const files5MB = Array.from(files).filter(x => x.size > 5 * 1024 * 1024);
                    if (files5MB.length > 0) {
                        $(`#createTab1Modal input[name="${input.name}"]`).val(null);
                        toastr.error('File upload không được vượt quá 5MB.');
                    }
                }
                renderPreviewFileUploadNew(input.name, files);
            })
        })
    }

    function renderPreviewFileUploadNew(name, files, action = 'VIEW') {
        const fileListNew = document.getElementById(`${name}_new`);
        fileListNew.innerHTML = ""; // Clear any previous entries
        for (const file of files) {
            const listItem = document.createElement("li");

            const linkItem = document.createElement("a");
            linkItem.href = `#`;
            linkItem.text = file.name;
            linkItem.style.textDecoration = "none";
            listItem.appendChild(linkItem);

            if (action !== 'VIEW') {
                const removeLink = document.createElement("a");
                removeLink.href = "#";
                removeLink.textContent = "(Xóa)";
                removeLink.style.color = "red";
                removeLink.style.marginLeft = "10px";
                removeLink.style.textDecoration = "none";
                removeLink.style.cursor = "pointer";
                removeLink.onclick = function (event) {
                    event.preventDefault();
                    listItem.remove();
                };
                listItem.appendChild(removeLink);
            }

            fileListNew.appendChild(listItem);
        }
    }

    function renderPreviewFileUploadOld(name, lstFile, action = 'VIEW') {
        const fileListOld = document.getElementById(`${name}_old`);
        const files = JSON.parse(lstFile);
        let resFiles = files;
        if (!resFiles) return;
        for (const file of files) {
            const listItem = document.createElement("li");

            const linkItem = document.createElement("a");
            linkItem.href = `/${file.file_url}`;
            linkItem.text = file.file_name;
            linkItem.style.textDecoration = "none";
            linkItem.target = '_blank';
            listItem.appendChild(linkItem);

            if (action !== 'VIEW') {
                const removeLink = document.createElement("a");
                removeLink.href = "#";
                removeLink.textContent = "(Xóa)";
                removeLink.style.color = "red";
                removeLink.style.marginLeft = "10px";
                removeLink.style.textDecoration = "none";
                removeLink.style.cursor = "pointer";
                removeLink.setAttribute("data-id", file.id);
                removeLink.onclick = function (event) {
                    event.preventDefault();
                    const fileId = removeLink.getAttribute("data-id");
                    resFiles = resFiles.filter(x => x.id !== fileId);
                    $(`input[name="${name}_info"]`).val(JSON.stringify(resFiles))
                    listItem.remove();
                };
                listItem.appendChild(removeLink);
            }

            fileListOld.appendChild(listItem);
        }
    }

    function clickShowFiles(files) {
        $('#lstFileDinhKiemModal').html('');
        const formatValue = files && files !== '' ? JSON.parse(files) : null;
        if (formatValue && formatValue.length > 0) {
            for (let item of formatValue) {
                $('#lstFileDinhKiemModal').append(`<li><a target="_blank" href="/${item.file_url}">${item.file_name}</a></li>`);
            }
        } else {
            $('#lstFileDinhKiemModal').html('<p class="text-center">Không có file đính kèm.</p>');
        }
        $('#fileDinhKemModal').modal('show');
    }

    function getDetailHistoryById(id) {
        // Lấy danh sách lịch sử chỉnh sửa
        $.ajax({
            url: `api/public-building/history-edit/${id}`, // Replace with your API endpoint
            type: 'GET',
            headers: {
                'X-CSRF-Token': $('input[name="csrf_token"]').val() // Include the CSRF token in the headers
            },
            success: function (res) {
                const data = res.result;
                renderContentHistoryEdit(data);
            },
            error: function (err) {
                // Handle error
                toastr.error(err.responseJSON?.error);
            }
        });
    }

    function renderContentHistoryEdit(data) {
        $('#tab-HistoryModal').html('');
        if (data.length > 0) {
            let content = '';
            Array.from(data).forEach((item, idx) => {
                const valDiffs = compare2Object(JSON.parse(item.du_lieu_cu), JSON.parse(item.du_lieu_moi));
                content += renderContentHistory(item, valDiffs, data.length - idx);
            });
            $('#tab-HistoryModal').html(content);
        } else {
            $('#tab-HistoryModal').html(`<p class="text-center">Không có dữ liệu.</p>`);
        }
    }

    const ignoreFields = [
        "ngay_tao",
        "nguoi_tao",
        "ngay_sua",
        "nguoi_sua",
        "ngay_xoa",
        "nguoi_xoa",
        "trang_thai_xoa",
        "tai_san_id",
        "ma_px",
        "ma_qh",
        "ma_tp"
    ]

    const labelFields = {
        "ma_dat": "Mã tài sản",
        "ten_dat": "Tên tài sản",
        "don_vi_quan_ly_id": "Đơn vị quản lý",
        "hien_trang_sd_id": "Hiện trạng sử dụng",
        "dien_tich": "Diện tích",
        "so_to": "Số tờ",
        "so_thua": "Số thửa",
        "dia_chi": "Địa chỉ",
        "ten_px": "Phường/Xã",
        "ten_qh": "Quận/Huyện",
        "ten_tp": "Tỉnh/TP",
        "ds_file_dinh_kem": "Danh sách file đính kèm"
    }

    function compare2Object(obj1, obj2) {
        const differences = {};
        const allKeys = new Set([...Object.keys(obj1), ...Object.keys(obj2)]);
        allKeys.forEach((key) => {
            if (obj1[key] != obj2[key]) {
                const itemIgnore = ignoreFields.findIndex(x => x === key);
                if (itemIgnore === -1) {
                    let obj1_key = obj1[key] ?? '';
                    let obj2_key = obj2[key] ?? '';
                    if (obj1[key] === 'null' || obj1[key] === '[]') obj1_key = '';
                    if (obj2[key] === 'null' || obj2[key] === '[]') obj2_key = '';
                    if (obj1_key !== obj2_key) {
                        differences[key] = { from: obj1[key], to: obj2[key] };
                    }
                }
            }
        });

        return differences;
    }

    function renderContentHistory(item, obj, idx) {
        let content = '';
        content += `<div class="w-100">
                        <p class="mb-1"><b>Lần ${idx}: <i>${item.ngay_tao} - ${item.nguoi_chinh_sua}</i></b></p>
                        <p class="mb-2">Lý do: ${item.ly_do_chinh_sua}</b></p>
                        <ul>`;
        Object.keys(obj).forEach(key => {
            const valFrom = obj[key]?.from ?? '';
            const valTo = obj[key]?.to ?? '';
            let dataFrom = valFrom;
            let dataTo = valTo;
            const arrLabelField = globalParams.filter(x => x.ma_truong === key);
            if (arrLabelField[0]?.kieu_du_lieu === "file") {
                dataFrom = '';
                dataTo = '';
                let formatFrom = obj[key]?.from ? JSON.parse(obj[key]?.from) : [];
                let formatTo = obj[key]?.to ? JSON.parse(obj[key]?.to) : [];
                Array.from(formatFrom).forEach(file => {
                    dataFrom += `${file.file_name}; `;
                })
                Array.from(formatTo).forEach(file => {
                    dataTo += `${file.file_name}; `;
                })
            } else if (arrLabelField[0]?.kieu_du_lieu === "date") {
                dataFrom = '';
                dataTo = '';
                let formatFrom = obj[key]?.from;
                let formatTo = obj[key]?.to;
                if (formatFrom) {
                    dataFrom = convertDateStringToFormat(formatFrom);
                }
                if (formatTo) {
                    dataTo = convertDateStringToFormat(formatTo);
                }
            }

            let txtLabel = arrLabelField[0]?.ten_truong;
            if (key === 'ten_px') {
                txtLabel = 'Phường/Xã';
            } else if (key === 'ten_qh') {
                txtLabel = 'Quận/Huyện';
            } else if (key === 'ten_tp') {
                txtLabel = 'Tỉnh/TP';
            }

            content += `<li>
                            <span>${txtLabel}</span>: <span class="required">${dataFrom}</span> => <b style="color:green;">${dataTo}</b>
                        </li>`;
        })
        content += `    </ul>
                    </div>`;
        return content;
    }

    function convertDateStringToFormat(value) {
        const dateObject =  new Date(value);
        const day = String(dateObject.getUTCDate()).padStart(2, '0');
        const month = String(dateObject.getUTCMonth() + 1).padStart(2, '0'); // Months are zero-based
        const year = dateObject.getUTCFullYear();
        // Format into dd/MM/yyyy
        const formattedDate = `${day}/${month}/${year}`;
        return formattedDate;
    }
</script>
{% endblock %}