{% extends "templates/base_index_v2.html" %}
{% block title %}{{ i18n('interface.public_building.title') }}{% endblock %}
{% block new_resource_label %}{{ i18n('interface.public_building.new_public_building') }}{% endblock %}
{% block breadcrumb %}
<nav aria-label="breadcrumb">
    <ol class="breadcrumb">
        <li class="breadcrumb-item active">{{ utils.render_icon('house-door-fill') }}</li>
        <li class="breadcrumb-item active">Quản lý tài sản</li>
        <li class="breadcrumb-item" aria-current="page">Nhà công sản</li>
    </ol>
</nav>
{% endblock %}
{% block scripts %}
{{super()}}
<script src="{{ url_for('static', filename='libs/select2/select2.min.js') }}"></script>
{% endblock %}
{% block styles %}
{{ super() }}
<link href="{{ url_for('static', filename='libs/select2/select2.min.css') }}" rel="stylesheet">
<style>
    #tab-DuLieuModal .nav-link {
        color: #7B809A;
    }

    #tab-DuLieuModal .nav-link.active {
        color: #fff;
        background-color: #0093D8;
    }

    #v-pills-tab {
        border-right: 1px solid #f5f5f5;
    }

    #v-pills-tabContent .tab-pane.active {
        display: inline-flex;
    }

    #btn-DuLieuTaiSan {
        color: blue;
        text-decoration: underline;
    }

    @media (min-width: 576px) {
        #createTab1Modal .modal-dialog {
            max-width: 700px !important;
        }
    }
</style>
{% endblock %}
{% block table %}
<ul class="nav nav-tabs w-100" id="tabNhaCongSan" role="tablist">
    <li class="nav-item" role="presentation">
        <button class="nav-link active" id="tabDuLieuChinh" data-bs-toggle="tab" data-bs-target="#tab-DuLieuChinh"
            data-target-modal="#createTab1Modal" type="button" role="tab" aria-controls="tab-DuLieuChinh"
            aria-selected="true">Ds nhà công sản</button>
    </li>
    <!-- <li class="nav-item" role="presentation">
        <button class="nav-link" id="tabChoPheDuyet" data-bs-toggle="tab" data-bs-target="#tab-ChoPheDuyet"
            data-target-modal="#createTab2Modal" type="button" role="tab" aria-controls="tab-ChoPheDuyet"
            aria-selected="false">Ds chờ phê duyệt</button>
    </li> -->
</ul>
<div class="tab-content px-4 py-4">
    <div class="tab-pane fade show active" id="tab-DuLieuChinh" role="tabpanel" aria-labelledby="tab-DuLieuChinh">
        <table id="tableDuLieuChinh" class="display responsive">
            <thead>
                <tr>
                    <th>STT</th>
                    <th style="min-width: 100px;">Mã tài sản</th>
                    <th style="min-width: 175px;">Tên tài sản</th>
                    <th style="min-width: 200px;">Địa chỉ</th>
                    <th style="min-width: 142px;">Mã tờ thửa</th>
                    <th style="min-width: 142px;">Mã tờ đất</th>
                    <th>Ảnh/Văn bản</th>
                    <th style="min-width: 100px;">Ngày tạo</th>
                    <th class="text-center" style="min-width: 100px;">Tác vụ</th>
                </tr>
            </thead>
            <tbody>
            </tbody>
        </table>
    </div>
    <div class="tab-pane fade" id="tab-ChoPheDuyet" role="tabpanel" aria-labelledby="tab-ChoPheDuyet">
        <!-- <table id="tableChoPheDuyet" class="display responsive">
            <thead>
                <tr>
                    <th>STT</th>
                    <th style="min-width: 175px;">Tên nhóm tham số</th>
                    <th style="min-width: 100px;">Thứ tự hiển thị</th>
                    <th style="min-width: 100px;">Ngày tạo</th>
                    <th class="text-center" style="min-width: 100px;">Tác vụ</th>
                </tr>
            </thead>
            <tbody>
            </tbody>
        </table> -->
    </div>
</div>
{% endblock %}
{% block addNewModal %}
<div class="modal fade" id="chonTaiSanCoSanModal" tabindex="-1" data-bs-keyboard="false" data-bs-backdrop="static"
    aria-labelledby="chonTaiSanCoSanModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    Chọn mã tài sản có sẵn
                </h5>
            </div>
            <div class="modal-body my-2">
                <div class="d-flex justify-content-center">
                    <form id="dmPhanLoaiTSForm" class="row g-3 needs-validation" novalidate method="post">
                        <div class="d-flex w-100 flex-column">
                            <p class="text-center">Vui lòng lựa chọn mã tài sản có sẵn trong hệ thống.</p>
                            <select id="select-maTaiSan" class="form-control w-100" name="selectMaTaiSan"></select>
                        </div>
                    </form>
                </div>
                <div class="d-flex m-4" id="select-content-detail"></div>
                <div class="d-flex justify-content-center mt-4" style="gap: 10px;">
                    <button type="button" class="btn btn-maTaiSan-next">{{ utils.render_icon('arrow-right') }} Tiếp
                        tục</button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{{
                        utils.render_icon('x-circle') }}
                        Hủy</button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}
{% block titleStep1Modal %}
Thêm mới dữ liệu nhà công sản
{% endblock %}
{% block bodyStep1Modal %}
<form id="dmPhanLoaiTSForm" class="row g-3 needs-validation" novalidate method="post">
    <div class="d-flex w-100 flex-column">
        <p class="text-center">Vui lòng lựa chọn danh mục phân loại tài sản cho nhà công sản.</p>
        <select id="select-phan-loai-ts" class="form-control w-100" name="ten_loai_ts"></select>
    </div>
</form>
{% endblock %}
{% block bodyCreateTab1Modal %}
<ul class="nav nav-tabs w-100" id="tabDuLieuChinhModal" role="tablist">
    <li class="nav-item" role="presentation">
        <button class="nav-link active" id="tabDuLieuModal" data-bs-toggle="tab" data-bs-target="#tab-DuLieuModal"
            type="button" role="tab" aria-controls="tab-DuLieuModal" aria-selected="true">Dữ liệu</button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="tabBanDoModal" data-bs-toggle="tab" data-bs-target="#tab-BanDoModal" type="button"
            role="tab" aria-controls="tab-BanDoModal" aria-selected="false">Bản đồ</button>
    </li>
</ul>
<div class="tab-content py-4">
    <div class="tab-pane fade show active" id="tab-DuLieuModal" role="tabpanel" aria-labelledby="tab-DuLieuModal">
        <form id="duLieuChinhForm" class="row g-3 needs-validation" novalidate method="post">
            <input type="text" name="id" hidden />
            <div class="d-flex align-items-start">
                <div class="nav flex-column nav-pills me-3 pe-2" id="v-pills-tab" role="tablist"
                    aria-orientation="vertical">
                    <button class="nav-link text-start active" id="thamChieu-tab" data-bs-toggle="pill"
                        data-bs-target="#thamChieu" type="button" role="tab" aria-controls="thamChieu"
                        aria-selected="true">Tham chiếu</button>
                    <button class="nav-link text-start" id="viTri-tab" data-bs-toggle="pill" data-bs-target="#viTri"
                        type="button" role="tab" aria-controls="viTri" aria-selected="false">Vị trí</button>
                    <!-- <button class="nav-link text-start" id="moTaVatLy-tab" data-bs-toggle="pill"
                        data-bs-target="#moTaVatLy" type="button" role="tab" aria-controls="moTaVatLy"
                        aria-selected="false">Mô tả vật lý</button>
                    <button class="nav-link text-start" id="phapLy-tab" data-bs-toggle="pill" data-bs-target="#phapLy"
                        type="button" role="tab" aria-controls="phapLy" aria-selected="false">Pháp lý</button> -->
                    <button class="nav-link text-start" id="thongTinThua-tab" data-bs-toggle="pill"
                        data-bs-target="#thongTinThua" type="button" role="tab" aria-controls="thongTinThua"
                        aria-selected="false">Thông tin thửa</button>
                    <button class="nav-link text-start" id="tinhTrangSuDung-tab" data-bs-toggle="pill"
                        data-bs-target="#tinhTrangSuDung" type="button" role="tab" aria-controls="tinhTrangSuDung"
                        aria-selected="false">Tình trạng sử dụng</button>
                </div>
                <div class="tab-content row w-100" id="v-pills-tabContent">
                    <div class="tab-pane row fade show active" id="thamChieu" role="tabpanel"
                        aria-labelledby="thamChieu-tab">
                        <div class="col-md-6 mt-3">
                            <label for="maTaiSan" class="form-label">Mã tài sản:<span class="required">*</span></label>
                            <input type="text" class="form-control" name="maTaiSan" required disabled>
                            <span class="w-100 mt-1 m-0">
                                <a id="btn-DuLieuTaiSan" data-bs-toggle="modal" data-bs-target="#chonTaiSanCoSanModal"
                                    role="button">+ Chọn dữ
                                    liệu tài sản có sẵn</a>
                            </span>
                        </div>
                        <div class="col-md-6 mt-3">
                            <label for="tenTaiSan" class="form-label">Tên tài sản:<span
                                    class="required">*</span></label>
                            <input type="text" class="form-control" name="tenTaiSan" required>
                        </div>
                        <div class="col-md-6 mt-3">
                            <label for="maCoSo" class="form-label">Mã cơ sở:<span class="required">*</span></label>
                            <input type="text" class="form-control" name="maCoSo" required>
                        </div>
                        <div class="col-md-6 mt-3">
                            <label for="tenCoQuan" class="form-label">Tên cơ quan:<span
                                    class="required">*</span></label>
                            <input type="text" class="form-control" name="tenCoQuan" required>
                        </div>
                        <div class="col-md-6 mt-3">
                            <label for="loaiTaiSan" class="form-label">Loại tài sản:<span
                                    class="required">*</span></label>
                            <input type="text" class="form-control" name="loaiTaiSan" required>
                        </div>
                    </div>
                    <div class="tab-pane row fade" id="viTri" role="tabpanel" aria-labelledby="viTri-tab">
                        <div class="col-md-6 mt-3">
                            <label for="tinhTP" class="form-label">Tỉnh/TP:<span class="required">*</span></label>
                            <input type="text" class="form-control" name="tinhTP" required>
                        </div>
                        <div class="col-md-6 mt-3">
                            <label for="quanHuyen" class="form-label">Quận/Huyện:<span class="required">*</span></label>
                            <input type="text" class="form-control" name="quanHuyen" required>
                        </div>
                        <div class="col-md-6 mt-3">
                            <label for="phuongXa" class="form-label">Phường/Xã:<span class="required">*</span></label>
                            <input type="text" class="form-control" name="phuongXa" required>
                        </div>
                        <div class="col-md-6 mt-3">
                            <label for="diaDiem" class="form-label">Địa điểm:<span class="required">*</span></label>
                            <input type="text" class="form-control" name="diaDiem" required>
                        </div>
                        <div class="col-md-6 mt-3">
                            <label for="toaDoDiaLy" class="form-label">Tọa độ địa lý:<span
                                    class="required">*</span></label>
                            <input type="text" class="form-control" name="toaDoDiaLy" required>
                        </div>
                    </div>
                    <div class="tab-pane row fade" id="moTaVatLy" role="tabpanel" aria-labelledby="moTaVatLy-tab">

                    </div>
                    <div class="tab-pane row fade" id="thongTinThua" role="tabpanel" aria-labelledby="thongTinThua-tab">
                        <div class="col-md-6 mt-3">
                            <label for="maSoTo" class="form-label">Mã số tờ:</label>
                            <input type="number" class="form-control" name="maSoTo" required>
                        </div>
                        <div class="col-md-6 mt-3">
                            <label for="maSoThua" class="form-label">Mã số thửa:</label>
                            <input type="number" class="form-control" name="maSoThua" required>
                        </div>
                        <div class="col-md-6 mt-3">
                            <label for="fileDinhKems" class="form-label">Ảnh/Văn bản:</label>
                            <input type="file" class="form-control" name="fileDinhKems" required>
                        </div>
                    </div>
                    <div class="tab-pane row fade" id="thongTinThua" role="tabpanel" aria-labelledby="thongTinThua-tab">

                    </div>
                    <div class="tab-pane row fade" id="tinhTrangSuDung" role="tabpanel"
                        aria-labelledby="tinhTrangSuDung-tab">

                    </div>
                </div>
            </div>
        </form>
    </div>
    <div class="tab-pane fade" id="tab-BanDoModal" role="tabpanel" aria-labelledby="tab-BanDoModal">
        <iframe
            src="/map_viewer?t=DaNang_PBM_Shpfile&l=edit_polygons%2Cedit_points%2Cedit_lines%2CNHA_CS_METADATA%2CDAT_CS_METADATA%2COpenStreetMap&bl=&c=12043404%2C1810885&s=20000"
            width="100%" height="600px" frameborder="0" allowfullscreen
            sandbox="allow-scripts allow-same-origin allow-top-navigation allow-forms allow-popups allow-pointer-lock allow-popups-to-escape-sandbox"></iframe>
    </div>
</div>
{% endblock %}

{% block renderScripts %}
<script type="text/javascript">
    document.addEventListener('DOMContentLoaded', function () {
        // Init show modal create
        const createButton = document.getElementById('createModal');
        if (createButton) {
            createButton.setAttribute('data-bs-target', '#step1Modal')
        }

        $("#select-phan-loai-ts").select2({
            placeholder: 'Chọn danh mục phân loại tài sản...',
            allowClear: true,
            minimumInputLength: 0, // Number of characters before AJAX request is made
            dropdownParent: $('#step1Modal'),
            ajax: {
                url: 'api/asset-type/type/categories/all', // API endpoint URL
                dataType: 'json',
                delay: 250,
                processResults: function (data) {
                    return {
                        results: data.result
                    };
                },
                cache: true
            }
        });

        // TODO
        let listMaTaiSan = [];
        $("#select-maTaiSan").select2({
            placeholder: 'Chọn mã tài sản...',
            allowClear: true,
            minimumInputLength: 0, // Number of characters before AJAX request is made
            dropdownParent: $('#chonTaiSanCoSanModal'),
            ajax: {
                url: 'api/public-building/categories/all', // API endpoint URL
                dataType: 'json',
                delay: 250,
                processResults: function (data) {
                    listMaTaiSan = data;
                    return {
                        results: data.result
                    };
                },
                cache: true
            }
        });

        // Event listener for change event
        $("#select-maTaiSan").on('change', function () {
            var selectedValue = $(this).val();
            // Add any additional logic you want to execute on change
            let itemSelected = listMaTaiSan['result'].filter(x => x.id === selectedValue);
            const selectMaTaiSan = document.getElementById("select-content-detail");
            if (selectedValue) {
                selectMaTaiSan.innerHTML = `
                    <ul>
                        <li>Mã tài sản: ${itemSelected[0].id}</li>
                        <li>Tên tài sản: ${itemSelected[0].ten_ts}</li>
                        <li>Địa chỉ: ${itemSelected[0].dia_chi}</li>
                        <li>Mã số tờ: ${itemSelected[0].ma_to_thua}</li>
                        <li>Mã số thửa: ${itemSelected[0].ma_to_dat}</li>
                    </ul>
                `;
            } else {
                selectMaTaiSan.innerHTML = '';
            }

            console.log(itemSelected);
        });

        $('#createTab1Modal').on('shown.bs.modal', function () {
            let id = $('#createTab1Modal input[name="id"]').val();
            if (!id) {
                $('#createTab1Modal .modal-title').html('Thêm mới dữ liệu');
                // Nếu là thêm mới thì tự động gợi ý mã tài sản
                const timestamp = Math.floor(Date.now() / 1000);
                let valMaTaiSan = `NDCS-${new Date().getFullYear()}${timestamp}`;
                $('#createTab1Modal input[name="maTaiSan"]').val(valMaTaiSan);
            } else {

            }
        });
    })

    $(document).ready(function () {
        // Validate lựa chọn danh mục phân loại tài sản
        $('#dmPhanLoaiTSForm').validate({
            rules: {
                ten_loai_ts: {
                    required: true
                }
            },
            messages: {
                ten_loai_ts: {
                    required: "Vui lòng nhập chọn danh mục.",
                }
            },
            errorClass: "is-invalid",
            validClass: "is-valid",
            errorElement: "div",
            errorPlacement: function (error, element) {
                if (element.hasClass('select2-hidden-accessible')) {
                    // Insert the error message after the Select2 container
                    error.addClass("invalid-feedback");
                    error.insertAfter(element.next('.select2-container'));
                } else {
                    error.addClass("invalid-feedback");
                    error.insertAfter(element);
                }
            },
            highlight: function (element, errorClass, validClass) {
                $(element).addClass(errorClass).removeClass(validClass);
                if ($(element).hasClass('select2-hidden-accessible')) {
                    $(element).next('.select2-container').addClass(errorClass);
                }
            },
            unhighlight: function (element, errorClass, validClass) {
                $(element).removeClass(errorClass).addClass(validClass);
                if ($(element).hasClass('select2-hidden-accessible')) {
                    $(element).next('.select2-container').removeClass(errorClass);
                }
            }
        });

        $('#step1Modal .btn-step1-next').on('click', function () {
            if ($('#dmPhanLoaiTSForm').valid()) {
                $('#step1Modal').modal('hide');
                $('#createTab1Modal').modal('show');
            }
        });

        const fieldDuLieuChinh = [
            "stt",
            "ma_ts",
            "ten_ts",
            "dia_chi",
            "ma_to_thua",
            "ma_to_dat",
            "ds_file_dinh_kem",
            "ngay_tao",
            "tac_vu"
        ];

        let tableDuLieuChinh = new DataTable('#tableDuLieuChinh', {
            dom: 'rtlip',
            ordering: true,
            scrollY: 300,
            scrollX: true,
            scrollCollapse: true,
            processing: true,
            // serverSide: true,
            searching: { regex: true },
            pageLength: 10,
            responsive: false,
            pagingType: "simple_numbers",
            language: PBMSLang,
            order: [],
            data: [
                {
                    "ma_ts": "NDCS-20224303233",
                    "ten_ts": "Trường tiểu học An Khê",
                    "dia_chi": "K245 Trường Chinh, phường An Khê, Thanh Khê, Đà Nẵng",
                    "ma_to_thua": "30",
                    "ma_to_dat": "32",
                    "ds_file_dinh_kem": "",
                    "ngay_tao": "25/11/2024 10:12"
                },
                {
                    "ma_ts": "NDCS-20257336410",
                    "ten_ts": "BQL chợ Nguyễn Tri Phương",
                    "dia_chi": "KDC số 01 Nguyễn Tri Phương, phường Hòa Cường Bắc, Hải Châu, Đà Nẵng",
                    "ma_to_thua": "33",
                    "ma_to_dat": "64",
                    "ds_file_dinh_kem": "",
                    "ngay_tao": "12/10/2024 8:12"
                }
                , {
                    "ma_ts": "NDCS-202573256124",
                    "ten_ts": "Trường tiểu học Núi Thành",
                    "dia_chi": "Số 158 Ỷ Lan Nguyên Phi, phường Hòa Cường Bắc, Hải Châu, Đà Nẵng",
                    "ma_to_thua": "32",
                    "ma_to_dat": "561",
                    "ds_file_dinh_kem": "",
                    "ngay_tao": "02/11/2024 11:12"
                }
                , {
                    "ma_ts": "NDCS-20258687",
                    "ten_ts": "Trường THPT Nguyễn Hiền",
                    "dia_chi": "Số 61 Phan Đăng Lưu, phường Hòa Cường Nam, Hải Châu, Đà Nẵng",
                    "ma_to_thua": "6",
                    "ma_to_dat": "7",
                    "ds_file_dinh_kem": "",
                    "ngay_tao": "25/11/2024 10:12"
                }
            ],
            // ajax: {
            //     url: "api/public-land/page",
            //     type: "POST",
            //     contentType: 'application/json',
            //     dataType: "json",
            //     headers: {
            //         'X-CSRF-Token': $('input[name="csrf_token"]').val() // Include the CSRF token in the headers
            //     },
            //     data: function (d) {
            //         d.search.value = $('input[name=txt-search]').val();
            //         return JSON.stringify(d);
            //     },
            //     dataSrc: function (json) {
            //         json.recordsTotal = json.result.recordsTotal;
            //         json.recordsFiltered = json.result.recordsFiltered;
            //         return json.result.data;
            //     }
            // },
            initComplete: function () {

            },
            columnDefs: [
                { "defaultContent": "", "targets": "_all" },
                {
                    orderable: false, targets: getIdxFieldTable(fieldDuLieuChinh,
                        ['stt', 'ds_file_dinh_kem', 'ngay_tao', 'tac_vu'])
                },
                {
                    data: '',
                    targets: getIdxFieldTable(fieldDuLieuChinh, ['stt']),
                    render: function (data, type, full, meta) {
                        return meta.settings._iDisplayStart + meta.row + 1;
                    },
                },
                {
                    data: '',
                    targets: getIdxFieldTable(fieldDuLieuChinh, ['tac_vu']),
                    render: function (data, type, full, meta) {
                        return `<div class="btn-action text-center">
                                    <a class="btn btn-icon-edit" role="button" title="Sửa" onclick="showUpdateTab1Modal('${full.id}')">
                                        <span class="svg-icon svg-icon-edit"></span>    
                                    </a>    
                                    <a class="btn btn-icon-delete" role="button" onclick="showDeleteTab1Modal('${full.id}')">
                                        <span class="svg-icon svg-icon-delete" title="Xóa"></span>
                                    </a>    
                                </div>`
                    },
                },
            ],
            columns: [
                { className: 'noVis', targets: [0] },
                { data: 'ma_ts' },
                { data: 'ten_ts' },
                { data: 'dia_chi' },
                { data: 'ma_to_thua' },
                { data: 'ma_to_dat' },
                { data: 'ds_file_dinh_kem' },
                { data: 'ngay_tao' },
                { className: 'noVis' },
            ]
        });
    })
</script>
{% endblock %}