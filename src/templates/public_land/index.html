{% extends "templates/base_index_v2.html" %}
{% block title %}{{ i18n('interface.public_land.title') }}{% endblock %}
{% block new_resource_label %}{{ i18n('interface.public_land.new_public_land') }}{% endblock %}
{% block breadcrumb %}
<nav aria-label="breadcrumb">
    <ol class="breadcrumb">
        <li class="breadcrumb-item active">{{ utils.render_icon('house-door-fill') }}</li>
        <li class="breadcrumb-item active">Quản lý tài sản</li>
        <li class="breadcrumb-item" aria-current="page">Đất công</li>
    </ol>
</nav>
{% endblock %}
{% block scripts %}
{{super()}}
<script src="{{ url_for('static', filename='libs/select2/select2.min.js') }}"></script>
{% endblock %}
{% block styles %}
{{ super() }}
<link href="{{ url_for('static', filename='libs/select2/select2.min.css') }}" rel="stylesheet">
<style>
    @media (min-width: 576px) {
        #createTab1Modal .modal-dialog {
            max-width: 1000px !important;
        }
    }
</style>
{% endblock %}
{% block table %}
<ul class="nav nav-tabs w-100" id="tabDatCong" role="tablist">
    <li class="nav-item" role="presentation">
        <button class="nav-link active" id="tabDuLieuChinh" data-bs-toggle="tab" data-bs-target="#tab-DuLieuChinh"
            data-target-modal="#createTab1Modal" type="button" role="tab" aria-controls="tab-DuLieuChinh"
            aria-selected="true">Ds tài sản</button>
    </li>
    <!-- <li class="nav-item" role="presentation">
        <button class="nav-link" id="tabChoPheDuyet" data-bs-toggle="tab" data-bs-target="#tab-ChoPheDuyet"
            data-target-modal="#createTab2Modal" type="button" role="tab" aria-controls="tab-ChoPheDuyet"
            aria-selected="false">Ds chờ phê duyệt</button>
    </li> -->
</ul>
<div class="tab-content px-4 py-4">
    <div class="tab-pane fade show active" id="tab-DuLieuChinh" role="tabpanel" aria-labelledby="tab-DuLieuChinh">
        <table id="tableDuLieuChinh" class="display responsive">
            <thead>
                <tr>
                    <th>STT</th>
                    <th style="min-width: 200px;">Mã tài sản</th>
                    <th style="min-width: 175px;">Tên tài sản</th>
                    <th style="min-width: 200px;">Địa chỉ</th>
                    <th style="min-width: 100px;">Số tờ</th>
                    <th style="min-width: 100px;">Số thửa</th>
                    <th style="min-width: 142px;">Diện tích (m2)</th>
                    <th style="min-width: 100px;">Hiện trạng <br> sử dụng</th>
                    <th>Ảnh/Văn bản</th>
                    <th style="min-width: 100px;">Ngày tạo</th>
                    <th class="text-center" style="min-width: 100px;">Tác vụ</th>
                </tr>
            </thead>
            <tbody>
            </tbody>
        </table>
    </div>
    <div class="tab-pane fade" id="tab-ChoPheDuyet" role="tabpanel" aria-labelledby="tab-ChoPheDuyet">
        <!-- <table id="tableChoPheDuyet" class="display responsive">
            <thead>
                <tr>
                    <th>STT</th>
                    <th style="min-width: 175px;">Tên nhóm tham số</th>
                    <th style="min-width: 100px;">Thứ tự hiển thị</th>
                    <th style="min-width: 100px;">Ngày tạo</th>
                    <th class="text-center" style="min-width: 100px;">Tác vụ</th>
                </tr>
            </thead>
            <tbody>
            </tbody>
        </table> -->
    </div>
</div>
{% endblock %}

{% block bodyCreateTab1Modal %}
<ul class="nav nav-tabs w-100" id="tabDuLieuChinhModal" role="tablist">
    <li class="nav-item" role="presentation">
        <button class="nav-link active" id="tabDuLieuModal" data-bs-toggle="tab" data-bs-target="#tab-DuLieuModal"
            type="button" role="tab" aria-controls="tab-DuLieuModal" aria-selected="true">Dữ liệu</button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="tabBanDoModal" data-bs-toggle="tab" data-bs-target="#tab-BanDoModal" type="button"
            role="tab" aria-controls="tab-BanDoModal" aria-selected="false">Bản đồ</button>
    </li>
</ul>
<div class="tab-content px-4 py-4">
    <div class="tab-pane fade show active" id="tab-DuLieuModal" role="tabpanel" aria-labelledby="tab-DuLieuModal">
        <form id="duLieuChinhForm" class="row g-3 needs-validation" novalidate method="post">
            <input type="text" name="id" hidden />
            <input type="text" name="lyDoChinhSuaID" hidden />
            <input type="text" name="lyDoChinhSuaTEXT" hidden />
            <div class="col-md-5">
                <label for="ma_dat" class="form-label">Mã tài sản:<span class="required">*</span></label>
                <input type="text" class="form-control" name="ma_dat" required disabled>
            </div>
            <div class="col-md-7">
                <label for="ten_dat" class="form-label">Tên tài sản:<span class="required">*</span></label>
                <input type="text" class="form-control" name="ten_dat" required>
            </div>
            <div class="col-md-6">
                <label for="don_vi_quan_ly_id" class="form-label">Đơn vị quản lý:</label>
                <select id="select-don-vi-quan-ly" class="form-control w-100" name="don_vi_quan_ly_id"></select>
            </div>
            <div class="col-md-6">
                <label for="hien_trang_sd_id" class="form-label">Hiện trạng sử dụng:<span
                        class="required">*</span></label>
                <select id="select-hien-trang-sd" class="form-control w-100" name="hien_trang_sd_id"></select>
            </div>
            <div class="col-md-4">
                <label for="so_to" class="form-label">Số tờ:</label>
                <input type="number" name="so_to" class="form-control" />
            </div>
            <div class="col-md-4">
                <label for="so_thua" class="form-label">Số thửa:</label>
                <input type="number" name="so_thua" class="form-control" />
            </div>
            <div class="col-md-4">
                <label for="dien_tich" class="form-label">Diện tích (m2):</label>
                <input type="number" name="dien_tich" class="form-control" />
            </div>
            <div class="col-md-6">
                <label for="ma_tp" class="form-label">Tỉnh/TP:<span class="required">*</span></label>
                <select id="select-province" class="form-control w-100" name="ma_tp"></select>
            </div>
            <div class="col-md-6">
                <label for="ma_qh" class="form-label">Quận/Huyện:<span class="required">*</span></label>
                <select id="select-district" class="form-control w-100" name="ma_qh"></select>
            </div>
            <div class="col-md-6">
                <label for="ma_px" class="form-label">Phường/Xã:<span class="required">*</span></label>
                <select id="select-ward" class="form-control w-100" name="ma_px"></select>
            </div>
            <div class="col-md-6">
                <label for="dia_chi" class="form-label">Địa chỉ:<span class="required">*</span></label>
                <input type="text" class="form-control" name="dia_chi" required>
            </div>
            <div class="col-md-6">
                <label for="ds_file_dinh_kem" class="form-label">Ảnh / Văn bản đính kèm:</label>
                <input type="text" class="form-control" name="ds_file_dinh_kem" hidden>
                <input type="file" class="form-control" multiple>
            </div>
        </form>
    </div>
    <div class="tab-pane fade" id="tab-BanDoModal" role="tabpanel" aria-labelledby="tab-BanDoModal">
        <iframe
            src="/map_viewer?t=DaNang_PBM_Shpfile&l=edit_polygons%2Cedit_points%2Cedit_lines%2CNHA_CS_METADATA%2CDAT_CS_METADATA%2COpenStreetMap&bl=&c=12043404%2C1810885&s=20000"
            width="100%" height="600px" frameborder="0" allowfullscreen
            sandbox="allow-scripts allow-same-origin allow-top-navigation allow-forms allow-popups allow-pointer-lock allow-popups-to-escape-sandbox"></iframe>
    </div>
</div>
{% endblock %}
{% block addNewModal %}
<div class="modal fade" id="chonLyDoCapNhatDuLieuModal" tabindex="-1" data-bs-keyboard="false" data-bs-backdrop="static"
    aria-labelledby="chonLyDoCapNhatDuLieuModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    Cập nhật dữ liệu
                </h5>
            </div>
            <div class="modal-body my-2">
                <div class="d-flex justify-content-center">
                    <form id="lyDoCapNhatDuLieuForm" class="row g-3 needs-validation" novalidate method="post">
                        <div class="d-flex w-100 flex-column">
                            <p class="text-center">Vui lòng lựa chọn lý do cập nhật dữ liệu.</p>
                            <select id="select-lyDoCapNhatDuLieu" class="form-control w-100"
                                name="selectLyDoCapNhatDuLieu"></select>
                        </div>
                    </form>
                </div>
                <div class="d-flex m-4" id="select-content-detail"></div>
                <div class="d-flex justify-content-center mt-4" style="gap: 10px;">
                    <button type="button" class="btn btn-theme btn-lyDoCapNhatDuLieu-next"
                        onclick="showUpdateTab1Modal()">{{ utils.render_icon('arrow-right') }}
                        Tiếp
                        tục</button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{{
                        utils.render_icon('x-circle') }}
                        Hủy</button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block renderScripts %}
<script type="text/javascript">
    document.addEventListener('DOMContentLoaded', function () {
        $('#createTab1Modal').on('shown.bs.modal', function () {
            // get danh mục
            let id = $('#createTab1Modal input[name="id"]').val();
            if (!id) {
                $('#createTab1Modal .modal-title').html('Thêm mới dữ liệu');
                // Nếu là thêm mới thì tự động gợi ý mã tài sản
                const timestamp = Math.floor(Date.now() / 1000);
                let valMaTaiSan = `NDCS-${new Date().getFullYear()}${timestamp}`;
                $('#createTab1Modal input[name="ma_dat"]').val(valMaTaiSan);
            }

            $("#select-don-vi-quan-ly").select2({
                placeholder: 'Chọn đơn vị quản lý...',
                allowClear: true,
                minimumInputLength: 0, // Number of characters before AJAX request is made
                escapeMarkup: function (m) { return m; },
                dropdownParent: $('#createTab1Modal'),
                ajax: {
                    url: 'api/units/all', // API endpoint URL
                    dataType: 'json',
                    delay: 250,
                    processResults: function (data) {
                        return {
                            results: data.result
                        };
                    },
                    cache: true
                }
            });

            $("#select-hien-trang-sd").select2({
                placeholder: 'Chọn hiện trạng sử dụng...',
                // allowClear: true,
                minimumInputLength: 0, // Number of characters before AJAX request is made
                escapeMarkup: function (m) { return m; },
                dropdownParent: $('#createTab1Modal'),
                ajax: {
                    url: 'api/categories/HTSD/all', // ma_nhom: HTSD | Hiện trạng sử dụng
                    dataType: 'json',
                    delay: 250,
                    processResults: function (data) {
                        return {
                            results: data.result
                        };
                    },
                    cache: true
                }
            });

            $('#select-don-vi-quan-ly').on('select2:clear', function () {
                console.log('Selection cleared!');
            });

            $("#select-province").select2({
                placeholder: 'Chọn Tỉnh/TP...',
                allowClear: true,
                minimumInputLength: 0, // Number of characters before AJAX request is made
                dropdownParent: $('#createTab1Modal'),
                ajax: {
                    url: 'api/categories/province', // API endpoint URL
                    dataType: 'json',
                    delay: 250,
                    processResults: function (data) {
                        return {
                            results: data.result
                        };
                    },
                    cache: true
                }
            });

            $('#select-province').on('select2:select', function (e) {
                // Do something
                let ma_tp = e.target.value;
                $("#select-district").select2({
                    placeholder: 'Chọn Quận Huyện...',
                    allowClear: true,
                    minimumInputLength: 0, // Number of characters before AJAX request is made
                    dropdownParent: $('#createTab1Modal'),
                    ajax: {
                        url: `api/categories/${ma_tp}/district`, // API endpoint URL
                        dataType: 'json',
                        delay: 250,
                        processResults: function (data) {
                            return {
                                results: data.result
                            };
                        },
                        cache: true
                    }
                });
            });
            $('#select-district').on('select2:select', function (e) {
                // Do something
                let ma_qh = e.target.value;
                $("#select-ward").select2({
                    placeholder: 'Chọn Phường Xã...',
                    allowClear: true,
                    minimumInputLength: 0, // Number of characters before AJAX request is made
                    dropdownParent: $('#createTab1Modal'),
                    ajax: {
                        url: `api/categories/48/${ma_qh}/ward`, // API endpoint URL
                        dataType: 'json',
                        delay: 250,
                        processResults: function (data) {
                            return {
                                results: data.result
                            };
                        },
                        cache: true
                    }
                });
            });
            $("#select-district").select2();
            $("#select-ward").select2();
        });

        $('#createTab1Modal').on('hide.bs.modal', function () {
            $('#duLieuChinhForm')[0].reset();
            $('#select-province').val(null).trigger('change');
            $('#select-district').val(null).trigger('change');
            $('#select-ward').val(null).trigger('change');
            $('#select-don-vi-quan-ly').val(null).trigger('change');
            $('#select-hien-trang-su-dung').val(null).trigger('change');
        })

        // Load danh mục lý do cập nhật dữ liệu
        $("#select-lyDoCapNhatDuLieu").select2({
            placeholder: 'Chọn lý do cập nhật dữ liệu...',
            // allowClear: true,
            minimumInputLength: 0, // Number of characters before AJAX request is made
            dropdownParent: $('#chonLyDoCapNhatDuLieuModal'),
            ajax: {
                url: 'api/categories/LyDoCapNhatDL/all', // ma_nhom: HTSD | Hiện trạng sử dụng
                dataType: 'json',
                delay: 250,
                processResults: function (data) {
                    return {
                        results: data.result
                    };
                },
                cache: true
            }
        });

        // MODAL Lý do cập nhật dữ liệu
        $('#chonLyDoCapNhatDuLieuModal').on('shown.bs.modal', function () {
            // TODO
        })

        $('#chonLyDoCapNhatDuLieuModal').on('hide.bs.modal', function () {
            $('#lyDoCapNhatDuLieuForm')[0].reset();
            $('#select-lyDoCapNhatDuLieu').val(null).trigger('change');
        })
    })

    $(document).ready(function () {
        // Search data
        $('.btn-search').on('click', function () {
            tableDuLieuChinh.ajax.reload(null, false);
        })

        $('#input-search').on('keydown', function (e) {
            if (event.key === "Enter" || event.keyCode === 13) {
                tableDuLieuChinh.ajax.reload(null, false);
            }
        })
        // Tab Ds dữ liệu chính     
        const fieldDuLieuChinh = [
            "stt",
            "ma_dat",
            "ten_dat",
            "full_dia_chi",
            "so_to",
            "so_thua",
            "dien_tich",
            "ten_hien_trang_sd",
            "ds_file_dinh_kem",
            "ngay_tao",
            "tac_vu"
        ];

        let tableDuLieuChinh = new DataTable('#tableDuLieuChinh', {
            dom: 'rtlip',
            ordering: true,
            scrollY: 300,
            scrollX: true,
            scrollCollapse: true,
            processing: true,
            serverSide: true,
            searching: { regex: true },
            pageLength: 10,
            responsive: false,
            pagingType: "simple_numbers",
            language: PBMSLang,
            order: [],
            ajax: {
                url: "api/public-land/page",
                type: "POST",
                contentType: 'application/json',
                dataType: "json",
                headers: {
                    'X-CSRF-Token': $('input[name="csrf_token"]').val() // Include the CSRF token in the headers
                },
                data: function (d) {
                    d.search.value = $('input[name=txt-search]').val();
                    return JSON.stringify(d);
                },
                dataSrc: function (json) {
                    json.recordsTotal = json.result.recordsTotal;
                    json.recordsFiltered = json.result.recordsFiltered;
                    return json.result.data;
                }
            },
            initComplete: function () {

            },
            columnDefs: [
                { "defaultContent": "", "targets": "_all" },
                {
                    orderable: false, targets: getIdxFieldTable(fieldDuLieuChinh,
                        ['stt', 'ten_hien_trang_sd', 'full_dia_chi',
                            'ds_file_dinh_kem', 'dien_tich', 'ngay_tao', 'tac_vu'])
                },
                {
                    data: '',
                    targets: getIdxFieldTable(fieldDuLieuChinh, ['stt']),
                    render: function (data, type, full, meta) {
                        return meta.settings._iDisplayStart + meta.row + 1;
                    },
                },
                {
                    data: '',
                    targets: getIdxFieldTable(fieldDuLieuChinh, ['tac_vu']),
                    render: function (data, type, full, meta) {
                        return `<div class="btn-action text-center">
                                    <a class="btn btn-icon-edit" role="button" title="Sửa" onclick="showLyDoCapNhatDuLieuModal('${full.id}')">
                                        <span class="svg-icon svg-icon-edit"></span>    
                                    </a>    
                                    <a class="btn btn-icon-delete" role="button" onclick="showDeleteTab1Modal('${full.id}')">
                                        <span class="svg-icon svg-icon-delete" title="Xóa"></span>
                                    </a>    
                                </div>`
                    },
                },
            ],
            columns: [
                { className: 'noVis', targets: [0] },
                { data: 'ma_dat' },
                { data: 'ten_dat' },
                { data: 'full_dia_chi' },
                { data: 'so_to' },
                { data: 'so_thua' },
                { data: 'dien_tich' },
                { data: 'ten_hien_trang_sd' },
                { data: 'ds_file_dinh_kem' },
                { data: 'ngay_tao' },
                { className: 'noVis' },
            ]
        });

        $('#duLieuChinhForm').validate({
            rules: {
                ma_dat: {
                    required: true,
                    maxlength: 50
                },
                ten_dat: {
                    required: true,
                    maxlength: 256
                },
                so_to: {
                    required: true,
                },
                so_thua: {
                    required: true,
                },
                hien_trang_sd_id: {
                    required: true,
                },
                dia_chi: {
                    required: true,
                    maxlength: 500
                },
                ma_px: {
                    required: true,
                },
                ma_qh: {
                    required: true,
                },
                ma_tp: {
                    required: true,
                }
            },
            messages: {
                ma_dat: {
                    required: "Vui lòng nhập mã tài sản.",
                    maxlength: "Tên nhóm tham số có độ dài tối đa 50 kí tự."
                },
                ten_dat: {
                    required: "Vui lòng nhập tên tài sản.",
                    maxlength: "Tên nhóm tham số có độ dài tối đa 256 kí tự."
                },
                hien_trang_sd_id: {
                    required: "Vui lòng chọn hiện trạng sử dụng.",
                },
                dia_chi: {
                    required: "Vui lòng nhập địa chỉ.",
                    maxlength: "Tên nhóm tham số có độ dài tối đa 500 kí tự."
                },
                so_to: {
                    required: "Vui lòng nhập số tờ.",
                },
                so_thua: {
                    required: "Vui lòng nhập số thửa.",
                },
                ma_px: {
                    required: "Vui lòng chọn Phường/Xã.",
                },
                ma_qh: {
                    required: "Vui lòng chọn Quận/Huyện.",
                },
                ma_tp: {
                    required: "Vui lòng chọn Tỉnh/TP.",
                },
            },
            errorClass: "is-invalid",
            validClass: "is-valid",
            errorElement: "div",
            errorPlacement: function (error, element) {
                if (element.hasClass('select2-hidden-accessible')) {
                    // Insert the error message after the Select2 container
                    error.addClass("invalid-feedback");
                    error.insertAfter(element.next('.select2-container'));
                } else {
                    error.addClass("invalid-feedback");
                    error.insertAfter(element);
                }
            },
            highlight: function (element, errorClass, validClass) {
                $(element).addClass(errorClass).removeClass(validClass);
                if ($(element).hasClass('select2-hidden-accessible')) {
                    $(element).next('.select2-container').addClass(errorClass);
                }
            },
            unhighlight: function (element, errorClass, validClass) {
                $(element).removeClass(errorClass).addClass(validClass);
                if ($(element).hasClass('select2-hidden-accessible')) {
                    $(element).next('.select2-container').removeClass(errorClass);
                }
            }
        });

        $('#createTab1Modal .btn-save').on('click', function () {
            if ($('#duLieuChinhForm').valid()) {
                // Collect form data
                const formData = new FormData($('#duLieuChinhForm')[0]);
                formData.append('ma_dat', $('input[name="ma_dat"]').val());
                formData.append('ten_tp', $("#select-province").select2('data')[0].text);
                formData.append('ten_qh', $("#select-district").select2('data')[0].text);
                formData.append('ten_px', $("#select-ward").select2('data')[0].text);
                formData.append('don_vi_quan_ly_id', $("#select-don-vi-quan-ly").val());
                formData.append('hien_trang_su_dung_id', $("#select-hien-trang-su-dung").val());

                // formData.append('ten_tp', $("#select-province").text());
                // formData.append('ten_qh', $("#select-district").text());
                // formData.append('ten_px', $("#select-ward").text());
                // formData.append('don_vi_quan_ly_id', $("#select-don-vi-quan-ly").val());
                // formData.append('hien_trang_su_dung_id', $("#select-hien-trang-su-dung").val());

                // Make AJAX call
                let ajax_url = 'api/public-land/create';
                let ajax_type = 'POST';
                let paramId = $('#duLieuChinhForm input[name="id"]').val();
                // Tồn tại Id thì call api update
                if (paramId) {
                    ajax_url = `api/public-land/update/${paramId}`;
                    ajax_type = 'PUT';
                }

                $.ajax({
                    url: ajax_url, // Replace with your API endpoint
                    type: ajax_type,
                    headers: {
                        'X-CSRF-Token': $('input[name="csrf_token"]').val() // Include the CSRF token in the headers
                    },
                    contentType: false, // Set content type to false for FormData
                    processData: false, // Prevent jQuery from setting the Content-Type header
                    data: formData, // Use FormData directly
                    success: function (res) {
                        // Handle success
                        toastr.success(res.message);
                        // Optionally, close the modal or reset the form
                        $('#createTab1Modal').modal('hide');
                        // Reload datatable
                        tableDuLieuChinh.ajax.reload(null, false);
                    },
                    error: function (err) {
                        // Handle error
                        toastr.error(err.error);
                    }
                });
            }
        });

        window.showLyDoCapNhatDuLieuModal = function (id) {
            $('#chonLyDoCapNhatDuLieuModal').modal('show');
            $('#select-lyDoCapNhatDuLieu').attr('data-row-id', id);
        }

        window.showUpdateTab1Modal = function () {
            // Khởi tạo validate form
            $('#lyDoCapNhatDuLieuForm').validate({
                rules: {
                    selectLyDoCapNhatDuLieu: {
                        required: true,
                    }
                },
                messages: {
                    selectLyDoCapNhatDuLieu: {
                        required: "Vui lòng chọn lý do.",
                    }
                },
                errorClass: "is-invalid",
                validClass: "is-valid",
                errorElement: "div",
                errorPlacement: function (error, element) {
                    if (element.hasClass('select2-hidden-accessible')) {
                        // Insert the error message after the Select2 container
                        error.addClass("invalid-feedback");
                        error.insertAfter(element.next('.select2-container'));
                    } else {
                        error.addClass("invalid-feedback");
                        error.insertAfter(element);
                    }
                },
                highlight: function (element, errorClass, validClass) {
                    $(element).addClass(errorClass).removeClass(validClass);
                    if ($(element).hasClass('select2-hidden-accessible')) {
                        $(element).next('.select2-container').addClass(errorClass);
                    }
                },
                unhighlight: function (element, errorClass, validClass) {
                    $(element).removeClass(errorClass).addClass(validClass);
                    if ($(element).hasClass('select2-hidden-accessible')) {
                        $(element).next('.select2-container').removeClass(errorClass);
                    }
                }
            });

            if ($('#lyDoCapNhatDuLieuForm').valid()) {
                let valLyDoCapNhatDL = $("#select-lyDoCapNhatDuLieu").select2('data')[0].id;
                let textLyDoCapNhatDL = $("#select-lyDoCapNhatDuLieu").select2('data')[0].text;
                $('#duLieuChinhForm [name="lyDoChinhSuaID"]').val(valLyDoCapNhatDL);
                $('#duLieuChinhForm [name="lyDoChinhSuaTEXT"]').val(textLyDoCapNhatDL);
                // Ẩn modal Chọn lý do cập nhật dữ liệu
                $('#chonLyDoCapNhatDuLieuModal').modal('hide');
                const rowID = $('#select-lyDoCapNhatDuLieu').attr('data-row-id');
                // Show modal detail cập nhật dữ liệu
                $.ajax({
                    url: `api/public-land/detail/${rowID}`, // Replace with your API endpoint
                    type: 'GET',
                    headers: {
                        'X-CSRF-Token': $('input[name="csrf_token"]').val() // Include the CSRF token in the headers
                    },
                    success: async function (res) {
                        const data = res.result;
                        $('#duLieuChinhForm [name="id"]').val(data.id);
                        $('#duLieuChinhForm [name="ma_dat"]').val(data.ma_dat);
                        $('#duLieuChinhForm [name="ten_dat"]').val(data.ten_dat);
                        $('#duLieuChinhForm [name="so_to"]').val(data.so_to);
                        $('#duLieuChinhForm [name="so_thua"]').val(data.so_thua);
                        $('#duLieuChinhForm [name="dien_tich"]').val(data.dien_tich);
                        $('#duLieuChinhForm [name="ds_file_dinh_kem"]').val(data.ds_file_dinh_kem);
                        $('#duLieuChinhForm [name="dia_chi"]').val(data.dia_chi);
                        // Trigger validation on each field to show feedback
                        // Get all param
                        if (data.don_vi_quan_ly_id && data.don_vi_quan_ly_id !== '') {
                            $('#select-don-vi-quan-ly').append(new Option(data.ten_don_vi_quan_ly, data.don_vi_quan_ly_id, true, true)).trigger('change');
                        }
                        if (data.hien_trang_sd_id && data.hien_trang_sd_id !== '') {
                            $('#select-hien-trang-sd').append(new Option(data.ten_hien_trang_sd, data.hien_trang_sd_id, true, true)).trigger('change');
                        }
                        $('#select-province').append(new Option(data.ten_tp, data.ma_tp, true, true)).trigger('change');
                        $('#select-district').append(new Option(data.ten_qh, data.ma_qh, true, true)).trigger('change');
                        $('#select-ward').append(new Option(data.ten_px, data.ma_px, true, true)).trigger('change');
                        $('#duLieuChinhForm').validate().form();
                        // Show confirmation modal
                        $('#createTab1Modal').modal('show');
                        $('#createTab1Modal .modal-title').html('Cập nhật dữ liệu');
                    },
                    error: function (err) {
                        // Handle error
                        toastr.error(err.responseJSON?.error);
                    }
                });
            }
        }

        window.showDeleteTab1Modal = function (id) {
            // Show confirmation modal
            $('#deleteTab1Modal').modal('show');
            // Set the delete button action
            $('#deleteTab1Modal .btn-delete').off('click').on('click', function () {
                // Make AJAX call to delete the item
                $.ajax({
                    url: `api/public-land/delete/${id}`, // Replace with your API endpoint
                    type: 'DELETE',
                    headers: {
                        'X-CSRF-Token': $('input[name="csrf_token"]').val() // Include the CSRF token in the headers
                    },
                    success: function (res) {
                        // Handle success
                        toastr.success(res.message);
                        // Close the modal
                        $('#deleteTab1Modal').modal('hide');
                        // Reload datatable
                        tableDuLieuChinh.ajax.reload(null, false);
                    },
                    error: function (err) {
                        // Handle error
                        toastr.error(err.responseJSON?.error);
                        // Close the modal
                        $('#deleteTab1Modal').modal('hide');
                    }
                });
            });
        }
    })
</script>
{% endblock %}